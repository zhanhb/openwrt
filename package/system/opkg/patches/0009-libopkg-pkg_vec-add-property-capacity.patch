From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Huangbin Zhan <zhanhb88@gmail.com>
Date: Mon, 8 Nov 2021 01:02:38 +0800
Subject: [PATCH] libopkg: pkg_vec: add property capacity

Signed-off-by: Huangbin Zhan <zhanhb88@gmail.com>
---
 libopkg/pkg_vec.c | 26 +++++++++++++++++++-------
 libopkg/pkg_vec.h |  2 ++
 2 files changed, 21 insertions(+), 7 deletions(-)

--- a/libopkg/pkg_vec.c
+++ b/libopkg/pkg_vec.c
@@ -27,6 +27,7 @@ pkg_vec_t *pkg_vec_alloc(void)
 	pkg_vec_t *vec = xcalloc(1, sizeof(pkg_vec_t));
 	vec->pkgs = NULL;
 	vec->len = 0;
+	vec->capacity = 0;
 
 	return vec;
 }
@@ -104,9 +105,14 @@ void pkg_vec_insert_merge(pkg_vec_t * ve
 
 void pkg_vec_insert(pkg_vec_t * vec, const pkg_t * pkg)
 {
-	vec->pkgs = xrealloc(vec->pkgs, (vec->len + 1) * sizeof(pkg_t *));
-	vec->pkgs[vec->len] = (pkg_t *) pkg;
-	vec->len++;
+	unsigned old_capacity = vec->capacity, new_capacity;
+	if (vec->len == old_capacity) {
+		new_capacity = old_capacity * 2;
+		if (new_capacity < 4) new_capacity = 4;
+		vec->pkgs = xrealloc(vec->pkgs, new_capacity * sizeof(pkg_t *));
+		vec->capacity = new_capacity;
+	}
+	vec->pkgs[vec->len++] = (pkg_t *) pkg;
 }
 
 int pkg_vec_contains(pkg_vec_t * vec, pkg_t * apkg)
@@ -168,6 +174,7 @@ abstract_pkg_vec_t *abstract_pkg_vec_all
 	vec = xcalloc(1, sizeof(abstract_pkg_vec_t));
 	vec->pkgs = NULL;
 	vec->len = 0;
+	vec->capacity = 0;
 
 	return vec;
 }
@@ -185,10 +192,15 @@ void abstract_pkg_vec_free(abstract_pkg_
  */
 void abstract_pkg_vec_insert(abstract_pkg_vec_t * vec, abstract_pkg_t * pkg)
 {
-	vec->pkgs =
-	    xrealloc(vec->pkgs, (vec->len + 1) * sizeof(abstract_pkg_t *));
-	vec->pkgs[vec->len] = pkg;
-	vec->len++;
+	unsigned old_capacity = vec->capacity, new_capacity;
+	if (vec->len == old_capacity) {
+		new_capacity = old_capacity * 2;
+		if (new_capacity < 4) new_capacity = 4;
+		vec->pkgs =
+				xrealloc(vec->pkgs, new_capacity * sizeof(abstract_pkg_t *));
+		vec->capacity = new_capacity;
+	}
+	vec->pkgs[vec->len++] = pkg;
 }
 
 abstract_pkg_t *abstract_pkg_vec_get(abstract_pkg_vec_t * vec, int i)
--- a/libopkg/pkg_vec.h
+++ b/libopkg/pkg_vec.h
@@ -28,11 +28,13 @@ typedef struct abstract_pkg_vec abstract
 struct pkg_vec {
 	pkg_t **pkgs;
 	unsigned int len;
+	unsigned int capacity;
 };
 
 struct abstract_pkg_vec {
 	abstract_pkg_t **pkgs;
 	unsigned int len;
+	unsigned int capacity;
 };
 
 pkg_vec_t *pkg_vec_alloc(void);
